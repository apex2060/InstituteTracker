<div id="signup" ng-app> 
	<form id="formCreate" class="form-horizontal" data-schema="organization" data-hash="/account/welcome" ng-submit="submit()" ng-controller="formCtrl">
		<input type="hidden" id="lat" value="default">
		<input type="hidden" id="lng" value="default">
		<h3>Create Organization</h3>
		<div class="alert alert-error" ng-show="!it.isValid"><p>Welcome!  You need to login before you can create an organization.</p></div>
		<hr>
		<h4>Organization Information</h4>
		<!--Program Name, Program Type, Parent Program, Location(GPS & Address), Contact Information, Website-->
		<div class="control-group">
			<label class="control-label" for="type">Program Type</label>
			<div class="controls">
				<label class="radio inline">
					<input type="radio" id="type" name="type" value="Seminary" ng-model="type" required> Seminary
				</label>
				<label class="radio inline">
					<input type="radio" id="type" name="type" value="Institute" ng-model="type" required> Institute
				</label>
			</div>
		</div>
		<div class="control-group">
			<label class="control-label" for="name">Program Name</label>
			<div class="controls">
				<input type="text" id="name" name="name" placeholder="Program Name" ng-model="name" required>
			</div>
		</div>
		<div class="control-group">
			<label class="control-label" for="director">Director Name</label>
			<div class="controls">
				<input type="text" id="director" name="director" placeholder="Director Name" required>
			</div>
		</div>
		<div class="control-group" ng-show="type=='Institute'">
			<label class="control-label" title="You can copy the 'Contact' information from LDS.org  and paste it here to quickly add it.">Quick Paste</label>
			<div class="controls">
				<textarea id="quickpaste"></textarea>
			</div>
			<label class="control-label"></label>
			<div class="controls">
				<a class="btn btn-warning" target="_new" href="http://institute.lds.org/find-institute/Search?q={{name}}&lang=eng">Lookup On LDS.org</a>
			</div>
		</div>
		<div class="control-group">
			<label class="control-label" for="address">Address</label>
			<div class="controls">
				<input type="text" id="address" name="address" placeholder="Address" required>
			</div>
		</div>
		<div class="control-group">
			<label class="control-label" for="phone">Phone Number</label>
			<div class="controls">
				<input type="tel" id="phone" name="phone" placeholder="555-555-5555">
			</div>
		</div>
		<div class="control-group">
			<label class="control-label" for="email">Email Number</label>
			<div class="controls">
				<input type="email" id="email" name="email" placeholder="org_name@ldschurch.org">
			</div>
		</div>

		<div class="map"><div id="map_canvas"></div></div>

		<div class="control-group">
			<label class="control-label" for="area">Area</label>
			<div class="controls">
				<input type="text" id="area" name="area" placeholder="Last Name" required>
				<span class="help-inline">This may be your state.</span>
			</div>
		</div>

		<button type="submit" class="btn btn-primary">Create Organization</button>
	</form>
	<script src="js/magicsuggest_class.js"></script>
	<script src="js/magicsuggest.js"></script>
	<script language="javascript" src="js/geolocation.js"></script>
	<script>
		$("input,select,textarea").not("[type=submit]").jqBootstrapValidation();

		var area = StackMob.Model.extend({ schemaName: 'area' });
		var areas = StackMob.Collection.extend({ model: area });
		var allAreas = new areas();
		allAreas.fetch({
			success: function(areas) {
				var list = jQuery.map(areas.toJSON(), function (a) {
					var t={};
					t.id=a.area_id;
					t.name=a.name;
					return t;
				});
				new MagicSuggest({
				    renderTo: $('#area'),
				    name: 'area',
				    selectionPosition: 'inner',
				    width: 250,
				    required:true,
				    maxSelection:1,
				    resultAsString:true,
				    editable:false,
				    data: list
				});
			}
		});

		$('#quickpaste').blur(function(){
			var contact	= parseContact($('#quickpaste').val());
			$('#address').val(contact['address_street']+' '+contact['address_zip']);
			$('#phone').val(contact['phone']);
			$('#email').val(contact['email']);
			codeAddress(contact['address_street']+' '+contact['address_zip']);
		});
		$('#address').blur(function(){
			codeAddress($(this).val());
		});


		/* MAPS */
		var map;
		loadMapScript();

		function loadMapScript(){
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "http://maps.googleapis.com/maps/api/js?key=AIzaSyAw0i5KC7opeWmEF4jE6oYWu0UxjTOINj4&sensor=false&callback=initialize_map";
			document.body.appendChild(script);
		}

		function initialize_map(lat,lng){
			it.geocoder = new google.maps.Geocoder();
			if(lat==undefined){
				var lat = it.currentLocation.coords.latitude;
				var lng = it.currentLocation.coords.longitude;
			}
			var mapOptions = {
				center: new google.maps.LatLng(lat,lng),
				zoom: 14,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			it.map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
		}

		function codeAddress(address){
		    it.geocoder.geocode( { 'address': address}, function(results, status) {
			    if (status == google.maps.GeocoderStatus.OK) {
			    	var geo = results[0].geometry.location;
			    	console.log(geo);

			    	$('#lat').val(geo.ib);
			    	$('#lng').val(geo.jb);
			        it.map.setCenter(geo, 16);

			        it.marker = new google.maps.Marker({
			        	map: it.map, 
			        	position: geo
			        });

			        it.marker.setDraggable (true);
			        google.maps.event.addListener(it.marker, "dragend", markerMove);
			    }
			});
		}
		function markerMove(event){
        	it.point = it.marker.getPosition();
        	it.map.panTo(it.point);
        	console.log(it.point);
		}
	</script>
</div>